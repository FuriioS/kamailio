From 7cc7bde95757ea8861c07acafeb528e09e0b52ac Mon Sep 17 00:00:00 2001
From: Hugh Waite <hugh.waite@crocodile-rcs.com>
Date: Wed, 4 Dec 2013 22:37:31 +0000
Subject: [PATCH] dialog_ng: Fix segfault in dlg_new_dialog

(cherry picked from commit 32f9c9187a9d886c46b24ee38173274da63febda)
---
 modules/dialog_ng/dlg_handlers.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/modules/dialog_ng/dlg_handlers.c b/modules/dialog_ng/dlg_handlers.c
index 262e923..93a00c7 100644
--- a/modules/dialog_ng/dlg_handlers.c
+++ b/modules/dialog_ng/dlg_handlers.c
@@ -905,9 +905,9 @@ int dlg_new_dialog(struct sip_msg *req, struct cell *t, const int run_initial_cb
     if (populate_leg_info(dlg, req, t, DLG_CALLER_LEG,
             &(get_from(req)->tag_value)) != 0) {
         LM_ERR("could not add further info to the dialog\n");
-        shm_free(dlg);
         lock_destroy(dlg->dlg_out_entries_lock);
         lock_dealloc(dlg->dlg_out_entries_lock);
+        shm_free(dlg);
         return -1;
     }
 
-- 
1.8.4.3

